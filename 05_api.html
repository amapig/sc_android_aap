
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>AAP API &mdash; Android Accessory Protocol Using XMOS v0.1 documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://mathjax.connectmv.com/MathJax.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="Android Accessory Protocol Using XMOS v0.1 documentation" href="index.html" />
    <link rel="next" title="TODO" href="06_todo.html" />
    <link rel="prev" title="APhone Application used in Demo" href="04_phone_app.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="04_phone_app.html"
                        title="previous chapter"> &lt&lt </a>
<a href="06_todo.html"
                        title="next chapter"> &gt&gt </a></p>
</div>

            
  <div class="section" id="aap-api">
<h1>AAP API<a class="headerlink" href="#aap-api" title="Permalink to this headline">¶</a></h1>
<div class="section" id="files">
<h2>Files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h2>
<p><strong>module_android_aap\src\usb_host_app_conf.h</strong></p>
<p>This file must provide generic USB host defines for your device. It has preprocessor defines that the USB Host will use.</p>
<p><strong>module_android_aap\src\AAP_if.h</strong></p>
<p>This file contains hook functions from USB host in order to follow specified enumeration process and attempt to start the Android device in &#8216;accessory&#8217; mode.</p>
<p><strong>module_android_aap\src\AndroidDescriptor.c</strong></p>
<p>This file contains USB decriptors for the Android device.</p>
</div>
<div class="section" id="configuration-defines-and-constants">
<h2>Configuration Defines and Constants<a class="headerlink" href="#configuration-defines-and-constants" title="Permalink to this headline">¶</a></h2>
<p><strong>NUM_CTRL_CHANENDS</strong></p>
<p>This is the number of control channel ends in your application associated with the number of interfaces in the descriptor. As we need to work with only one, this is defined as 1.</p>
<p><strong>START_CONFIG_NUM</strong></p>
<p>Index of the first configuration we want to request from the device. Required interface is present in configuration number 0.</p>
<p><strong>TIMED_EP_COUNT</strong></p>
<p>Maximum number of timed endpoints for isochronous and interrupt endpoints. As we are working with bulk endpoints, this defined as 0.</p>
<p><strong>INITIAL_GET_DEV_DESC_LEN</strong></p>
<p>Length of the initial Get Device Descriptor request. Currently set as 18. Extra descriptor bytes (if any) will be read automatically after reading the first 18 bytes. Request responses can be less than this length.</p>
<p><strong>DEFAULT_EP0_PIPE_WIDTH</strong></p>
<p>For Full Speed USB this is set as 64. This defines the maximum packet response length expected by the  host. Any packets shorter than this indicate the end of the data part of the packet.</p>
<p><strong>INITIAL_GET_CONF_DESC_LEN</strong></p>
<p>Length of the initial Get Configuration Descriptor request. Currently set as 255. Any extra bytes (if any) will be read automatically after reading the initial bytes. Configurations request responses can be less than this length.</p>
<p><strong>RECONNECT_PAUSE</strong></p>
<p>The amount of time (in mS) between connection / re-connection. Android accessory might need to re-introduce itself after putting the Android device in &#8216;special&#8217; accessory mode. This will require a re-connection.</p>
<p><strong>USBHOST_VID_PID_HOOK_ON</strong></p>
<p>This should be defined for AAP as we need a hook from device descriptor mismatch. This hook will contain the code to start the Android device in accessory mode. This hook is called when the VID and PID fail to match the defined values.</p>
<p><strong>ACC_GET_PROTOCOL</strong></p>
<p>Control transfer command to get Android device&#8217;s protocol support. Currently set as 51 (0x33).</p>
<p><strong>ACC_SEND_STRING</strong></p>
<p>Control transfer command to send strings (introduce accessory) to the Android device. Currently set as 52 (0x34).</p>
<p><strong>ACC_MODE_START</strong></p>
<p>Control transfer command to set Android device in accessory mode. Currently set as 53 (0x35).</p>
<p><strong>EP_DESC_COUNT</strong></p>
<p>Number of endpoint descriptors to expect from the Android device. Nexus S Android phone has 2.</p>
<p><strong>IF_DESC_COUNT</strong></p>
<p>Number of interface descriptors to expect from the Android device. Nexus S Android phone has 1.</p>
<p><strong>vendorID</strong></p>
<p>Expected Vendor ID of the Android device. Nexus S VID is 0x18D1.</p>
<p><strong>productID</strong></p>
<p>Expected Product ID of the Android device in accessory mode. Nexus S PID should be either 0x2D00 or 0x2D01. The PID of this phone (when not in accessory mode) is 0x4E22.</p>
<p><strong>vendorIDMask</strong></p>
<p>Mask to match VID</p>
<p><strong>productIDMask</strong></p>
<p>Mask to match PID</p>
</div>
<div class="section" id="typedefs">
<h2>Typedefs<a class="headerlink" href="#typedefs" title="Permalink to this headline">¶</a></h2>
<p><strong>s_usb_endpoint</strong></p>
<p>The USB Endpoint descriptor. Each endpoint descriptor typedef will also contain function pointer for that specific endpoint type. For example, the IN endpoint has a function pointer to android_rx() to handle data response for an IN transfer.</p>
<p><strong>s_usb_interface</strong></p>
<p>The USB Interface descriptor. Each interface has handlers. The android_ctrl() function pointer is used as an interface between the application thread and the USB thread.</p>
</div>
<div class="section" id="prototypes">
<h2>Prototypes<a class="headerlink" href="#prototypes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="usbhost-user-vid-pid-fail">
<h3>USBHost_user_vid_pid_fail<a class="headerlink" href="#usbhost-user-vid-pid-fail" title="Permalink to this headline">¶</a></h3>
<p>Implementation file: module_android_aap\src\USBHostUser.c</p>
<p>Return type: int</p>
<p>Param:</p>
<ul class="simple">
<li>DeviceDescriptor <a href="#id1"><span class="problematic" id="id2">*</span></a>devicedesc - the device descriptor got from the USB device</li>
<li>int vendorIDMask - VID mask</li>
<li>int vendorID - VID. For Google Nexus S, this should be 18D1</li>
<li>int productIDMask - PID mask</li>
<li>int productID - PID. For Google Nexus S, this should be 4E21 when not in accessory mode and 2D00 or 2D01 when in accessory mode.</li>
</ul>
<p>Description:</p>
<p>When the Device descriptor do not match, it might be possible that the Android device is not in accessory mode. This hook is useful to attempt to start the Android device in accessory mode by checking the protocol, introducing accessory, setting the accessory mode (if any) and restarting the enumeration process.</p>
<p>Once the above process is done, the Android device should start in accessory mode satisfying the VID/PID match.</p>
</div>
<div class="section" id="android-ctrl">
<h3>android_ctrl<a class="headerlink" href="#android-ctrl" title="Permalink to this headline">¶</a></h3>
<p>Implementation file: module_android_aap\src\AAP_if.xc</p>
<p>Return type: int</p>
<p>Param:</p>
<ul class="simple">
<li>streaming chanend c - channel between application and USB thread. All data from the application comes via this channel.</li>
<li>int reqVal - Request value from the application.</li>
<li>int timeNow - current time.</li>
</ul>
<p>Description:</p>
<p>Every time the application thread wants to send data over the USB, it pushes data onto this channel (c). The data is received by this function from the application thread and it is passed to the USB as a Bulk OUT transfer.</p>
</div>
<div class="section" id="android-rx">
<h3>android_rx<a class="headerlink" href="#android-rx" title="Permalink to this headline">¶</a></h3>
<p>Implementation file: module_android_aap\src\AAP_if.xc</p>
<p>Return type: int</p>
<p>Param:</p>
<ul class="simple">
<li>streaming chanend c</li>
<li>unsigned char data[]</li>
<li>int datalen</li>
<li>int ackstate</li>
<li>int timedTrans</li>
</ul>
<p>Description:</p>
<p>Handle any data that comes in response to an IN.</p>
</div>
<div class="section" id="application-thread">
<h3>application_thread<a class="headerlink" href="#application-thread" title="Permalink to this headline">¶</a></h3>
<p>Implementation files: app_android_aap_ir\src\main.xc</p>
<p>Return type: int</p>
<p>Param:</p>
<ul class="simple">
<li>streaming chanend cCtrl[NUM_CTRL_CHANENDS] - all the control channels.</li>
<li>streaming chanend cSOFGen - USB SOF channel.</li>
<li>streaming chanend cVBus - USB VBus channel.</li>
<li>out port pGPIO - Port to setup VBus.</li>
</ul>
<p>Description:</p>
<p>This thread sets up the USB host by requesting disconnection notification, setup VBus and ask USB host to use internal SOF timing. It also interprets IR commands and prepares appropriate packet to send to the USB device. It send this packet over the control channel. The data on this channel is received by the android_ctrl() function.</p>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Android Accessory Protocol Using XMOS (0.1)</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_aap.html">Android Accessory Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_demo.html">Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_phone_app.html">APhone Application used in Demo</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">AAP API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#files">Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-defines-and-constants">Configuration Defines and Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#typedefs">Typedefs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prototypes">Prototypes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#usbhost-user-vid-pid-fail">USBHost_user_vid_pid_fail</a></li>
<li class="toctree-l3"><a class="reference internal" href="#android-ctrl">android_ctrl</a></li>
<li class="toctree-l3"><a class="reference internal" href="#android-rx">android_rx</a></li>
<li class="toctree-l3"><a class="reference internal" href="#application-thread">application_thread</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="06_todo.html">TODO</a></li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



